{% include 'head.html' %}
{% block title %}
  <h1 id='pageTitle'>{{ App.pageTitle }}</h1>
{% endblock %}

{% include 'search-syntax-doc-modal.html' %}

{# SEARCH PAGE BEGIN #}
<hr>
<form method='get' action='search.php' aria-label='Main search form'>
{# MAIN TEXTAREA FOR EXTENDED QUERY #}
<div class='row'>
  <div class='col-md-12 mb-2'>
    <h5><label for='extendedArea'>{{ 'Search query'|trans }}</label></h5>
    {# next div is wrapper to position pre below textarea #}
    <div style='position:relative;'>
      <input
        id='extendedArea'
        name='q'
        type='text'
        class='form-control'
        placeholder="{{ 'Enter search query, e.g.: %s'|trans|format(getExtendedSearchExample()) }}"
        spellcheck='false'
        value='{{ App.Request.query.get('q') ? App.Request.query.get('q')|trim|e('html_attr') }}' />
      <pre id='search-highlighting' class='form-control d-none' aria-hidden='true'><code></code></pre>
    </div>
    <p class='smallgray mt-2'>{{ 'Enter a term to search in title, body, date and elabid; or use advanced syntax, or a combination of both.'|trans }}<br>
      {{ 'Press %sctrl + enter%s or %sâŒ˜ + enter%s to submit search.'|trans|format('<kbd>', '</kbd>', '<kbd>', '</kbd>')|raw }}
    </p>
  </div>
</div>

<h3 title='{{ 'Toggle visibility'|trans }}' data-action='toggle-next' class='d-inline togglable-section-title' tabindex='0' role='button' aria-expanded='false'><i class='fas fa-caret-right fa-fw mr-2'></i>{{ 'Help'|trans }}</h3>
<div class='mt-2' hidden data-save-hidden='advancedSearchHelpDiv'>
  <p>{{ 'Allowed Fields'|trans }} (<code><span class='token keyword'>{{ 'field'|trans }}</span><span class='token punctuation'>:</span><span class='token string'> {{ 'value'|trans }}</span></code>):</p>
  <div class='row'>
    <div class='col-md-6'>
      <ul class='list-unstyled'>
        <li class='mb-2'><kbd>attachment:</kbd> {{ 'yes, no, simple or quoted term'|trans }}</li>
        <li class='mb-2'><kbd>author:</kbd> {{ 'simple or quoted term'|trans }}</li>
        <li class='mb-2'><kbd>body:</kbd> {{ 'simple or quoted term'|trans }}</li>
        <li class='mb-2'><kbd>category:</kbd> {{ 'simple or quoted term'|trans }}</li>
        <li class='mb-2'><kbd>custom_id:</kbd> {{ 'number'|trans }}</li>
        <li class='mb-2'><kbd>date:</kbd> {{ 'see date format'|trans }}</li>
        <li class='mb-2'><kbd>elabid:</kbd> {{ 'simple or quoted term'|trans }}</li>
      </ul>
    </div>

    <div class='col-md-6'>
      <ul class='list-unstyled'>
        <li class='mb-2'><kbd>group:</kbd> {{ 'simple or quoted term'|trans }}</li>
        <li class='mb-2'><kbd>locked:</kbd> {{ 'yes or no'|trans }}</li>
        <li class='mb-2'><kbd>rating:</kbd> {{ '1, 2, 3, 4, 5, or unrated or 0'|trans }}</li>
        <li class='mb-2'><kbd>status:</kbd> {{ 'simple or quoted term'|trans }}</li>
        <li class='mb-2'><kbd>timestamped:</kbd> {{ 'yes or no'|trans }}</li>
        <li class='mb-2'><kbd>title:</kbd> {{ 'simple or quoted term'|trans }}</li>
        <li class='mb-2'><kbd>visibility:</kbd> {{ 'simple or quoted term'|trans }}</li>
      </ul>
    </div>
  </div>
  <button type='button' class='btn btn-secondary' data-action='toggle-modal' data-target='advancedSearchModal'>{{ 'Show full syntax'|trans }}</button>
</div>

<hr>

<div class='row mb-2'>
  {# SEARCH IN #}
  <div class='col-md-4'>
    <label for='searchin'>{{ 'Search in'|trans }}</label>
    <select name='type' id='searchin' class='form-control'>
      <option value='experiments'>{% trans %}Experiment {% plural 2 %}Experiments{% endtrans %}</option>
      <option value='items'{{ Request.query.get('type') == 'items' ? ' selected' }}>{{ 'Resources'|trans }}</option>
    </select>
  </div>
  {# EXPERIMENTS CATEGORIES #}
  <div class='col-md-4' id='experimentsCategoriesDiv' {{ App.Request.query.get('type') == 'items' ? 'hidden' }}>
    <label for='experimentsCategoriesSelect'>{{ 'And category is'|trans }}</label>
    <select id='experimentsCategoriesSelect' class='form-control filterHelper' data-filter='category'>
      <option value='' data-action='clear'>{{ 'Select category'|trans }}</option>
      {% for category in experimentsCategoriesArr %}
        <option value='{{ category.title|e('html_attr') }}'>
          {{ category.title }}
        </option>
      {% endfor %}
    </select>
  </div>
  {# RESOURCES CATEGORIES (items types) #}
  <div class='col-md-4' id='resourcesCategoriesDiv' {{ App.Request.query.get('type') != 'items' ? 'hidden' }}>
    <label for='resourcesCategoriesSelect'>{{ 'And category is'|trans }}</label>
    <select id='resourcesCategoriesSelect' class='form-control filterHelper' data-filter='category'>
      <option value='' data-action='clear'>{{ 'Select category'|trans }}</option>
      {% for category in itemsTypesArr %}
        <option value='{{ category.title|e('html_attr') }}'>
          {{ category.title }}
        </option>
      {% endfor %}
    </select>
  </div>
  {# EXPERIMENTS STATUS #}
  <div class='col-md-4' id='experimentsStatusDiv' {{ App.Request.query.get('type') == 'items' ? 'hidden' }}>
    <label for='experimentsStatusSelect'>{{ 'And status is'|trans }}</label>
    <select id='experimentsStatusSelect' class='form-control filterHelper' data-filter='status'>
      <option value='' data-action='clear'>{{ 'Select status'|trans }}</option>
      {% for category in experimentsStatusArr %}
        <option value='{{ category.title|e('html_attr') }}'>
          {{ category.title }}
        </option>
      {% endfor %}
    </select>
  </div>
  {# RESOURCES STATUS #}
  <div class='col-md-4' id='resourcesStatusDiv' {{ App.Request.query.get('type') != 'items' ? 'hidden' }}>
    <label for='resourcesStatusSelect'>{{ 'And status is'|trans }}</label>
    <select id='resourcesStatusSelect' class='form-control filterHelper' data-filter='status'>
      <option value='' data-action='clear'>{{ 'Select status'|trans }}</option>
      {% for category in itemsStatusArr %}
        <option value='{{ category.title|e('html_attr') }}'>
          {{ category.title }}
        </option>
      {% endfor %}
    </select>
  </div>
</div>

<div class='row mb-2'>
  {# SEARCH DATE #}
  <div class='col-md-6'>
    <label class='d-inline' for='date'>{{ 'Date from'|trans }}</label>
    <div class='input-group'>
      <div class='input-group-prepend'>
        <select id='dateOperator' aria-label='{{ 'Date operator'|trans }}' name='dateOperator' style='min-width: 50px' class='brr-none form-control filterHelper' data-filter='date'>
          <option value='<' title='{{ 'less than'|trans }}' {{- Request.query.get('dateOperator') == '<' ? ' selected' }}>&lt;</option>
          <option value='<=' title='{{ 'less than or equal to'|trans }}' {{- Request.query.get('dateOperator') == '<=' ? ' selected' }}>&le;</option>
          <option value='=' title='{{ 'equal to'|trans }}' {{- Request.query.get('dateOperator') == '=' or Request.query.get('dateOperator') is null ? ' selected' }}>=</option>
          <option value='>=' title='{{ 'greater than or equal to'|trans }}' {{- Request.query.get('dateOperator') == '>=' ? ' selected' }}>&ge;</option>
          <option value='>' title='{{ 'greater than'|trans }}' {{- Request.query.get('dateOperator') == '>' ? ' selected' }}>&gt;</option>
          <option value='!=' title='{{ 'not equal to'|trans }}' {{- Request.query.get('dateOperator') == '!=' ? ' selected' }}>&ne;</option>
        </select>
      </div>
      <input id='date' name='date' type='date' class='form-control filterHelper' data-filter='date' value='{{ Request.query.get('date') != '' ? Request.query.get('date') }}'/>
    </div>
  </div>
  <div class='col-md-6'>
    <label class='d-inline' for='dateTo'>{{ 'Date to (optional)'|trans }}</label>
    <input id='dateTo' name='dateTo' type='date' class='form-control filterHelper' data-filter='date' value='{{ Request.query.get('dateTo') != '' ? Request.query.get('dateTo') }}'/>
  </div>
  {# END SEARCH DATE #}
</div>

<hr>

{# NEW ROW #}
<div class='row mb-2'>
  {# AUTHOR/OWNER HELPER #}
  <div class='col-md-4'>
    <label for='searchonly'>{{ 'And author is'|trans }}/{{ 'belongs to group:'|trans }}</label><br>
    {% if App.Config.configArr.debug -%}
      <!-- [html-validate-disable-block element-permitted-content: suppress error from select picker: div child of button] -->
    {%- endif %}
    <select id='searchonly' name='owner' data-filter='(?:author|group)' class='form-control selectpicker filterHelper' data-show-subtext='true' data-live-search='true'>
      <option data-action='clear'>{{ 'Select author'|trans }}/{{ 'group'|trans }}</option>
      <optgroup label='{{ 'Users'|trans }}'>
        {% for user in usersArr %}
          <option value='author:{{ user.fullname|e('html_attr') }}' {{- Request.query.get('owner') == 'author:' ~ user.fullname ? ' selected' }}>[{{ 'author'|trans }}] {{ user.fullname }}</option>
        {% endfor %}
      </optgroup>
      <optgroup label='{{ 'Groups'|trans }}'>
        {% for group in teamGroups %}
          <option value='group:{{ group }}' {{- Request.query.get('owner') == 'group:' ~ group ? ' selected' }}>[{{ 'group'|trans }}] {{ group }}</option>
        {% endfor %}
      </optgroup>
    </select>
  </div>
  {# END AUTHOR/OWNER HELPER #}

  {# VISIBILITY SEARCH #}
  <div class='col-md-4'>
    <label for='visibility'>{{ 'And visibility is:'|trans }} </label><br>
    <select id='visibility' name='vis' data-filter='visibility' class='form-control filterHelper'>
      <option value='' data-action='clear'>{{ 'Select visibility'|trans }}</option>
      {% for value in visibilityArr %}
        <option {{- Request.query.get('vis') == value ? ' selected' }}>{{ value|trans }}</option>
      {% endfor %}
    </select>
  </div>
  {# END VISIBILITY SEARCH #}
</div>

{# NEW ROW #}
<div class='row mb-2'>
  {# RATING #}
  <div class='col-md-6'>
    <label for='rating'>{{ 'And rating is'|trans }}</label>
    <select id='rating' name='rating' data-filter='rating' class='form-control filterHelper'>
      <option value='' data-action='clear'>{{ 'Select number of stars'|trans }}</option>
      <option value='unrated' {{- Request.query.get('rating') == 'unrated' ? ' selected' }}>{{ 'Unrated'|trans }}</option>
      {% for i in range(1, 5) %}
        <option {{- Request.query.get('rating') == i ? ' selected' }}>{{ i }}</option>
      {% endfor %}
    </select>
  </div>
  {# END RATING #}
  {# LOCK #}
  <div class='col-md-3'>
    <label for='locked'>{{ 'Locked'|trans }}</label>
    <select id='locked' name='locked' class='form-control filterHelper' data-filter='locked'>
      <option value='' data-action='clear'>{{ 'Select lock status'|trans }}</option>
      <option value='yes' {{- Request.query.get('locked') == 'yes' ? ' selected' }}>{{ 'Yes'|trans|lower }}</option>
      <option value='no' {{- Request.query.get('locked') == 'no' ? ' selected' }}>{{ 'No'|trans|lower }}</option>
    </select>
  </div>
  {# END LOCK #}

  {# TIMESTAMPED #}
  <div class='col-md-3'>
    <label for='timestamped'>{{ 'Timestamped'|trans }}</label>
    <select id='timestamped' name='timestamped' class='form-control filterHelper' data-filter='timestamped'>
      <option value='' data-action='clear'>{{ 'Select timestamp status'|trans }}</option>
      <option value='yes' {{- Request.query.get('timestamped') == 'yes' ? ' selected' }}>{{ 'Yes'|trans|lower }}</option>
      <option value='no' {{- Request.query.get('timestamped') == 'no' ? ' selected' }}>{{ 'No'|trans|lower }}</option>
    </select>
  </div>
  {# END LOCK #}
</div>

<hr>
{# METADATA SEARCH #}
<h4 data-action='toggle-next' class='d-inline togglable-section-title mt-3 mb-2' tabindex='0' role='button' aria-expanded='false'><i class='fas fa-caret-right fa-fw mr-2'></i>{{ 'Extra fields search'|trans }}</h4>
<div hidden data-save-hidden='metadataSearchDiv'>
  {# add as many extra fields as present in the query but at least one #}
  {% for metakey in (Request.query.all('metakey') ?: ['']) %}
    {% set metavalue = Request.query.all('metavalue')[loop.index0] %}
    <div class='row' {{- loop.first ? " id='metadataFirstInputs'" }}>
      <div class='col-md-4'>
        {% set randomid = random() %}
        <label for='metakey_{{ randomid }}'>{{ 'Name of field'|trans }}</label>
        <input type='text' id='metakey_{{ randomid }}' class='form-control' name='metakey[]' value='{{ metakey != '' ? metakey }}' />
      </div>
      <div class='col-md-4'>
        <label for='metavalue_{{ randomid }}'>{{ 'Value'|trans }}</label>
        <input type='text' id='metavalue_{{ randomid }}' class='form-control' name='metavalue[]' value='{{ metavalue != '' ? metavalue }}' />
        <p>{{ "Tip: you can use '%' as wildcard"|trans }}</p>
      </div>
    </div>
  {% endfor %}

  {# button to add an extra field input #}
  <div data-action='add-extra-fields-search-inputs'><i class='fas fa-plus-circle fa-2x'></i></div>
</div>

{# Search action buttons #}
<div style='margin:30px;' class='text-center'>
  <button id='searchButton' class='btn btn-primary' value='Submit' type='submit'>
    {{ 'Launch search'|trans }}
  </button>
  <a href='search.php' class='btn btn-danger'>
    {{ 'Clear all'|trans }}
  </a>
</div>

{# if there is no query, end the form here, otherwise let it open so the filter/order/sort menu can be part of it
  it avoids having to repeat the query params #}
{% if App.Request.query.has('type') %}
  <h2 id='anchor'>{{ 'Results'|trans }}</h2>
{% else %}
  </form>
{% endif %}
