{% extends 'base.html' %}

{% block body %}

<!-- Modal for timestamping -->
<div class='modal fade' id='timestampModal' tabindex='-1' role='dialog' aria-labelledby='timestampModalLabel' aria-hidden='true'>
  <div class='modal-dialog' role='document'>
    <div class='modal-content'>
      <div class='modal-header'>
        <h5 class='modal-title' id='timestampModalLabel'>{{ 'Timestamp Experiment'|trans }}</h5>
        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
          <span aria-hidden='true'>&times;</span>
        </button>
      </div>
      <div class='modal-body' data-wait='{{ 'Please wait…' }}'>
        <p>{{ 'Timestamping your experiment is like taking a snapshot of your experiment at this instant, and storing it on the side, in an immutable archive. This snapshot is validated (timestamped) by a trusted third party.'|trans }}</p>
        {% if App.Config.configArr.ts_authority == 'universign' or App.Config.configArr.ts_authority == 'custom' %}
          <p><i class='fas fa-exclamation-triangle'></i>
            {{ 'Depending on your configuration, timestamping can incur costs. Are you sure you want to do this?'|trans }}
          </p>
        {% endif %}
      </div>
      <div class='timestamp-error'></div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary' data-dismiss='modal'>{{ 'Cancel'|trans }}</button>
        <button type='button' data-action='timestamp' class='btn btn-primary'>{{ 'Timestamp'|trans }}</button>
      </div>
    </div>
  </div>
</div>

{% embed 'view-edit.html' %}
  {% block createnew %}
    <div class='d-flex'>
      <!-- TODO replace 'entry' with experiment|item -->
      <div class='align-self-center'><h3>{{ Entity.page|capitalize }} > {{ 'Viewing an entry'|trans }}</h3></div>
      <div class='ml-auto'>
        {% include 'create-new.html' %}
      </div>
    </div>
  {% endblock %}
  {% block createmodal %}
    {% include 'show-view-edit.html' %}
  {% endblock %}
{% endembed %}

{% if Entity.entityData.timestamped %}
<div class='alert alert-success'><i class='fas fa-info-circle'></i>
  {{ 'Experiment was timestamped by %s on %s at %s'|trans|format(timestamperFullname, Entity.entityData.timestamped_at|date('Y-m-d'), Entity.entityData.timestamped_at|date('H:i:s'))|raw }}
</div>
{% endif %}

{% if Entity.entityData.locked %}
<div class='alert alert-success'><i class='fas fa-info-circle'></i>
  {{ 'Locked by %s on %s at %s'|trans|format(lockerFullname, Entity.entityData.locked_at|date('Y-m-d'), Entity.entityData.locked_at|date('H:i:s'))|raw }}
</div>
{% endif %}

<hr>

<!-- TOP TOOLBAR -->
<div class='d-flex align-items-center'>
  <!-- BACK TO LINK -->
  {% if App.Session.has('lastquery') %}
    {% set lastquery = App.Session.get('lastquery') %}
  {% else %}
    {% set lastquery = 'mode=show' %}
  {% endif %}

  <a title='{{ 'Back to listing'|trans }}' href='?{{ lastquery }}'>
    <div class='hl-hover-gray p-2 rounded'>
      <i class='fas fa-arrow-left fa-fw'></i>
    </div>
  </a>

  <div class='vertical-separator'></div>

  {% if not (Entity.isReadOnly or Entity.entityData.locked) %}
    {# EDIT #}
    <a class='mr-3' title='{{ 'Edit'|trans }}' href='?mode=edit&id={{ Entity.id }}'>
      <div class='hl-hover-gray p-2 rounded main-action-button'>
        <i class='fas fa-pencil fa-fw'></i>
      </div>
    </a>
  {% endif %}

  {% if not App.Session.has('is_anon') %}

    {# DUPLICATE #}
    <div class='mr-3'>
      <div title='{{ 'Duplicate'|trans }}' data-action='duplicate-entity' class='hl-hover-gray p-2 rounded'>
        <i class='fas fa-copy fa-fw'></i>
      </div>
    </div>

    {% if Entity.type == 'items' and Entity.entityData.bookable %}
      <a class='mr-3' title='{{ 'Book item'|trans }}' href='team.php?idtem={{ Entity.id }}'>
        <div class='hl-hover-gray p-2 rounded'>
          <i class='fas fa-calendar-plus fa-fw'></i>
        </div>
      </a>
    {% endif %}

  {% endif %}

  {% if not App.Session.has('is_anon') and App.Config.configArr.anon_users and Entity.entityData.access_key %}
    {# SHARE #}
    <div class='mr-3'>
      <div title='{{ 'Share'|trans }}' data-action='share' class='hl-hover-gray p-2 rounded'>
        <i class='fas fa-share-alt fa-fw'></i>
      </div>
    </div>
    <input type='text' class='form-control' aria-label='{{ 'Share'|trans }}' id='shareLinkInput' value='' hidden />
  {% endif %}

  <div class='vertical-separator'></div>

  {# TIMESTAMP EXPERIMENT #}
  {% if Entity.type == 'experiments' and not App.Session.has('is_anon') %}
    <div class='mr-3'>
      <div title='{{ 'Timestamp Experiment'|trans }}' data-action='toggle-modal' data-target='timestampModal' class='hl-hover-gray p-2 rounded'>
        <i class='fas fa-calendar-check fa-fw'></i>
      </div>
    </div>
  {% endif %}

  {# BLOXBERG TIMESTAMP #}
  {% if not Entity.isReadOnly and App.Config.configArr.blox_enabled %}
    <div class='mr-3'>
      <div title='{{ 'Add to blockchain'|trans }}' data-action='bloxberg' class='hl-hover-gray p-2 rounded'>
        <i class='fas fa-cubes fa-fw'></i>
      </div>
    </div>
  {% endif %}

  <div class='vertical-separator'></div>

  {# DOWNLOAD / EXPORT MENU #}
  <div class='dropdown'>
    <div class='hl-hover-gray d-inline p-2 rounded mr-3' title='{{ 'Export'|trans }}' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' aria-label='{{ 'Export'|trans }}' role='button'>
      <i class='fas fa-download fa-fw'></i>
    </div>
    <div class='dropdown-menu' aria-label='{{ 'Export'|trans }}'>
      <a class='dropdown-item' href='api/v2/{{ Entity.type }}/{{ Entity.id }}?format=pdf'><i class='fas fa-file-pdf fa-fw'></i> {{ 'PDF File'|trans }}</a>
      <a class='dropdown-item' href='api/v2/{{ Entity.type }}/{{ Entity.id }}?format=pdfa'><i class='fas fa-file-pdf fa-fw'></i> {{ 'Long term storage PDF'|trans }}</a>
      <a class='dropdown-item' href='api/v2/{{ Entity.type }}/{{ Entity.id }}?format=zip'><i class='fas fa-file-archive fa-fw'></i> {{ 'ZIP Archive'|trans }}</a>
      <a class='dropdown-item' href='api/v2/{{ Entity.type }}/{{ Entity.id }}?format=zipa'><i class='fas fa-file-archive fa-fw'></i> {{ 'Long term storage ZIP'|trans }}</a>
      <a class='dropdown-item' href='api/v2/{{ Entity.type }}/{{ Entity.id }}?format=eln'><i class='fas fa-box-archive fa-fw'></i> {{ 'ELN Archive'|trans }}</a>
      <a class='dropdown-item' href='api/v2/{{ Entity.type }}/{{ Entity.id }}?format=csv'><i class='fas fa-file-csv fa-fw'></i> {{ 'CSV File'|trans }}</a>
      <a class='dropdown-item' href='api/v2/{{ Entity.type }}/{{ Entity.id }}?format=qrpng'><i class='fas fa-qrcode fa-fw'></i> {{ 'QR Code'|trans }}</a>
    </div>
  </div>

  {% if not App.Session.has('is_anon') %}

    {# flex-nowrap to avoid going to two lines #}
    <div class='ml-auto d-flex flex-nowrap'>
      {# TOGGLE PIN #}
      <div class='mr-3'>
        <div title='{{ 'Toggle pin'|trans }}' data-action='toggle-pin' id='toggle-pin-icon-div' class='hl-hover-gray p-2 rounded'>
          <i id='toggle-pin-icon' class='fas fa-thumbtack {{ not Entity.Pins.isPinned ? 'color-weak' }} fa-fw'></i>
        </div>
      </div>

      {# LOCK #}
      {% set lockIcon = 'fa-lock-open' %}
      {% set alt = 'Lock/Unlock item'|trans %}
      {% if Entity.entityData.locked %}
          {% set lockIcon = 'fa-lock' %}
          {% set alt = Entity.entityData.locked_at %}
      {% endif %}
      <div title='{{ alt }}' data-action='lock-entity' class='hl-hover-gray p-2 rounded'>
        <i class='fas {{ lockIcon }} fa-fw'></i>
      </div>
    {% endif %}
  </div>
</div>


<hr>
<section id='main_section'>

  {# DATE and RATING #}
  <div class='d-flex'>
    {# DATE #}
    <div>
      {{ 'Started on'|trans }} {{ Entity.entityData.date|date('Y-m-d') }}
    </div>
    {# RATING #}
    <div class='ml-auto'>
      {% if Entity.entityData.rating > 0 %}
        <span class='rating-show rounded p-1'><i class='fas fa-star' title='☻'></i>{{ Entity.entityData.rating }}</span>
      {% endif %}
    </div>
  </div>

  {# TITLE #}
  <h1 id='documentTitle' class='mb-4 title text-dark'>
    {% if Entity.type == 'items' %}
      <span style='color:#{{ Entity.entityData.color }}'>{{ Entity.entityData.category }}</span>
    {% endif %}
    {{ Entity.entityData.title|raw }}
  </h1>

  {# CATEGORY #}
  <div class='d-flex mb-2 align-items-center'>
    <div class='edit-mode-label'>
      <i aria-hidden='true' class='fas fa-folder'></i> {{ Entity.type == 'experiments' ? 'Status'|trans : 'Category'|trans }}
    </div>
    <span style='--bg: #{{ Entity.entityData.color }}' class='category-button malleableCategory hl-hover-gray rounded p-1'>{{ Entity.entityData.category}}</span>
  </div>

  {# TAGS #}
  <div class='d-flex mb-2 align-items-center'>
    {% if Entity.entityData.tags|length > 0 %}
      <div class='edit-mode-label'>
        <i class='fas fa-tags mr-2'></i> {{ 'Tags'|trans }}
      </div>
      <span class='tags mathjax-ignore d-flex-inline flex-wrap'>
        {% set tagsIdArr = Entity.entityData.tags_id|split(',') %}
        {% set tagsValueArr = Entity.entityData.tags|split('|') %}
        {% for key, tag in tagsValueArr %}
          {# the key allows to get the id stored in tagsIdArr #}
          <a class='tag' href='?mode=show&tags%5B%5D={{ tag|url_encode }}'>{{ tag|raw }}</a>
        {% endfor %}
      </span>
    {% endif %}
  </div>

  {# PERMISSIONS #}
  <div class='d-flex mb-2 align-items-center'>
    {# CAN READ #}
    {% set rw = 'canread' %}
    {% set can = Entity.entityData.canread|canToHuman %}
    {% include('view-permissions.html') %}
  </div>
  <div class='d-flex mb-2 align-items-center'>
    {# CAN WRITE #}
    {% set rw = 'canwrite' %}
    {% set can = Entity.entityData.canwrite|canToHuman %}
    {% include('view-permissions.html') %}
  </div>

  <!-- SHOW EVENTS -->
  {% if Entity.entityData.is_bound %}<i class='far fa-calendar-alt'></i>
    <a href='#' data-action='see-events'>{{ 'See bookings'|trans }}</a>
  {% endif %}
  <div id='boundBookings'></div>

  <!-- SHOW NEXT STEP -->
  {% set next_step = Entity.entityData.next_step %}
  {% if next_step|length > 0 %}
      {% set nextStepsArr = next_step|split('|') %}
      {% set next = nextStepsArr|first %}
      <p>
      <span class='next-step-text'>{{ 'Next step'|trans }}:</span> <span class='text-dark'>{{ next|raw }}</span>
      </p>
  {% endif %}

  <!--  BODY (show only if not empty) -->
  {% set body = Entity.entityData.body %}
  {% if body != '' %}
    {% if Entity.entityData.content_type == constant('Elabftw\\Models\\AbstractEntity::CONTENT_MD') %}
      {% set body = Entity.entityData.body|md2html %}
    {% endif %}
    {# Workaround for bug #532; long tables result in empty body returned from md2html:
    If body is empty, reload and don't parse as markdown
    2022-06-07 note: could probably be removed now that we have content_type #}
      {% if body|trim == '' %}
          {% set body = Entity.entityData.body %}
      {% endif %}
      {# do not display body if set in metadata, done via css to avoid delayed disappearance after JS is executed #}
      {# body in view mode is text-dark for more lisibility see github issue #52 #}
      <div id='body_view' class='pt-2 text-dark' {{ not displayMainText ? 'hidden' }}>{{ body|raw }}</div>
  {% endif %}

  <!-- METADATA view -->
  {% if Entity.entityData.metadata %}
    <hr>
    <div>
      {{ Entity.entityData.metadata|formatMetadata }}
    </div>
  {% endif %}

</section>

<hr>

{% include 'steps-links-view.html' %}

{% include 'uploads.html' %}

<!-- only show the json editor if there is at least one file with a .json extension -->
{% if Entity.entityData.uploads|filter(u => u.real_name|getExt == 'json') %}
  {% include 'json-editor.html' %}
  <hr>
{% endif %}


<div id='commentsDiv'>
  {% if App.Session.get('is_auth') and not App.Session.has('is_anon') %}
    <div id='comment'>
    <h3 title='{{ 'Toggle visibility'|trans }}' data-action='toggle-next' data-icon='commentsIcon' class='d-inline'><i id='commentsIcon' class='fas fa-chevron-circle-down'></i> {{ 'Comments'|trans }}</h3>
    <div class='mt-2' id='commentsInnerDiv' data-save-hidden='commentsInnerDiv'>
        {% for comment in Entity.entityData.comments %}
          <div class='box'>
            <div class='comment-header text-muted p-2'>
              {{ comment.fullname|raw }} {{ 'commented'|trans }}
              <span title='{{ comment.created_at }}' class='relative-moment'></span>
              {% if comment.created_at != comment.modified_at %}
                ({{ 'edited'|trans }} <span title='{{ comment.modified_at }}' class='relative-moment'></span>)
              {% endif %}
              {% if comment.userid == Entity.Users.userData.userid %}
                <a class='float-right' data-action='destroy-comment' data-id='{{ comment.id }}' title='{{ 'Delete'|trans }}'>
                    <i class='fas fa-trash-alt fa-lg'></i>
                </a>
              {% endif %}
            </div>
            <!-- the comment itself is only editable by the owner -->
            <p class='comment m-2 p-2 {{ comment.userid == Entity.Users.userData.userid ? "editable hl-hover" }}' data-id='{{ comment.id }}'>{{ comment.comment|raw }}</p>
          </div>
        {% endfor %}

        <!-- CREATE COMMENT INPUT -->
        <div class='input-group my-1 rounded'>
          <textarea id='commentsCreateArea' class='form-control p-2 brr-none' autocomplete='off' placeholder='{{ 'Add a comment'|trans }}' aria-label='Comment area'></textarea>
          <div class='input-group-append'>
            <button class='btn btn-primary' type='button' data-action='create-comment'><i class='fas fa-paper-plane text-white'></i></button>
          </div>
        </div>
      </div>
    </div>
    <hr>
  {% endif %}
</div>

  <div class='text-right d-flex flex-column'>
    <!-- CHANGELOG -->
    <div>
      <i class='fas fa-list mr-1'></i>
      <a href='?id={{ Entity.id }}&mode=changelog'>{{ 'See changelog'|trans }}</a>
    </div>

    <!-- REVISIONS -->
    {% if revNum > 0 %}
      <div>
        <i class='fas fa-history mr-1'></i>
        <a href='revisions.php?type={{ Entity.type }}&item_id={{ Entity.id }}'>{{ revNum }}
          {% trans %}revision available{% plural revNum %}revisions available{% endtrans %}</a>
      </div>
    {% endif %}

    <!-- SHOW LAST MOD -->
    <div>
      <span>{{ 'Last modified on %s'|trans|format(Entity.entityData.modified_at) }}</span>
    </div>

    <!-- eLabID -->
    <div>
      <span class='elabid'>{{ 'Unique eLabID:'|trans }} {{ Entity.entityData.elabid }}</span>
    </div>
  </div>


<div id='info'
    data-page='view'
    data-type='{{ Entity.type }}'
    data-id='{{ Entity.id }}'
    data-team='{{ App.Users.userData.team }}'
    data-isanon='{{ App.Session.get('is_anon') }}'
    data-scedit='{{ Entity.Users.userData.sc_edit }}'>
</div>
<div id='shortcuts'
    data-create='{{ Entity.Users.userData.sc_create }}'>
</div>

{% endblock body %}
