{% extends 'base.html' %}

{% block body %}
{# tinymce or markdown? #}
{% set editor = 'tiny' %}
{% if Entity.Users.userData.use_markdown or App.Request.query.get('editor') == 'md' or Entity.entityData.content_type == '2' %}
  {% set editor = 'md' %}
{% endif %}
{% if App.Request.query.get('editor') == 'tiny' %}
  {% set editor = 'tiny' %}
{% endif %}


{% embed 'view-edit.html' %}
  {% block createnew %}
    <div class='d-flex'>
      <!-- TODO replace 'entry' with experiment|item -->
      <div class='align-self-center'><h3>{{ Entity.page|capitalize }} > {{ 'Editing an entry'|trans }}</h3></div>
      <div class='ml-auto'>
        {% include 'create-new.html' %}
      </div>
    </div>
  {% endblock %}
  {% block createmodal %}
    {% include 'show-view-edit.html' %}
  {% endblock %}
{% endembed %}

<!-- Modal for ownership transfer -->
<div class='modal fade' id='ownerModal' tabindex='-1' role='dialog' aria-labelledby='ownerModalLabel' aria-hidden='true'>
  <div class='modal-dialog' role='document'>
    <div class='modal-content'>
      <div class='modal-header'>
        <h5 class='modal-title' id='ownerModalLabel'>{{ 'Transfer ownership'|trans }}</h5>
        <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
          <span aria-hidden='true'>&times;</span>
        </button>
      </div>
      <div class='modal-body'>
        <!-- SELECT USER -->
        <label for='new_owner'>{{ 'New owner'|trans }}</label>
        <select id='new_owner' class='form-control'>
          {% for user in Entity.Users.readAllFromTeam %}
            <option value='{{ user.userid }}'
            {{ Entity.entityData.userid == user.userid ? ' selected' }}
            >{{ user.fullname|raw }}</option>
          {% endfor %}
        </select>
      </div>
      <div class='modal-footer'>
        <button type='button' class='btn btn-secondary' data-dismiss='modal'>{{ 'Close'|trans }}</button>
      </div>
    </div>
  </div>
</div>

<!-- show message if it was recently modified -->
{% set lastchangeDiff = 'now'|date('U') - Entity.entityData.modified_at|date('U') %}
{% if (lastchangeDiff < 600) and not Entity.entityData.lastchangeby is null and Entity.entityData.lastchangeby != Entity.Users.userData.userid %}
  {{ 'Warning: this entry was modified %s seconds ago by %s.'|trans|format(lastchangeDiff, lastModifierFullname)|msg('warning', false) }}
{% endif %}


{% include('view-edit-toolbar.html') %}

<section id='main_section'>

  <!-- DATE and RATING -->
  <div class='d-flex mb-2'>
    <div class='form-inline'>
      <label for='date_input' class='col-form-label mr-3 edit-mode-label justify-content-start'>{{ 'Started on'|trans }}</label>
      <!-- the input expects date in YYYY-MM-DD format, and it will be displayed according to the browser's locale -->
      <input id='date_input' data-trigger='blur' data-model='{{ Entity.type }}/{{ Entity.entityData.id }}' data-target='date' type='date' value='{{ Entity.entityData.date|date('Y-m-d') }}' class='form-control' />
    </div>
    <div class='ml-auto align-self-baseline'>
      <fieldset>
        <legend class='sr-only'>{{ 'Rating'|trans }}</legend>
        {% for i in range(1, 5) %}
        <input aria-label='{{ 'Rating'|trans }}' data-rating='{{ i }}' name='star' type='radio' class='star' value='{{ i }}' {{ Entity.entityData.rating == i ? ' checked=checked' }} />
        {% endfor %}
      </fieldset>
    </div>
  </div>

  <!-- TITLE -->
  <div class='d-flex mb-2 justify-content-between align-items-center'>
    <label for='title_input' class='col-form-label mr-3 edit-mode-label'>{{ 'Title'|trans }}</label>
    <!-- no data-trigger here because custom code in edit.ts -->
    <input id='title_input' class='form-control' type='text' value='{{ Entity.entityData.title|raw }}' required />
  </div>

  <!-- CATEGORIES (status for exp and itemstypes for items) -->
  <div class='d-flex mb-2 align-items-center'>
    <label for='category_select' class='col-form-label mr-3 edit-mode-label'>
    {% if Entity.type == 'experiments' %}
      {% trans %}Status{% plural 1 %}Status{% endtrans %}
    {% else %}
      {{ 'Category'|trans }}
    {% endif %}
    </label>
    <select id='category_select' class='form-control col-md-2'>
      <!-- TODO add a box with color -->
      {% for category in categoryArr %}
        <option value='{{ category.category_id }}'
        {{ Entity.entityData.category_id == category.category_id ? ' selected' }}>{{ category.category }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- TAGS -->
  <div class='d-flex mb-2 align-items-center mathjax-ignore'>
    <label for='createTagInput' class='col-form-label mr-3 edit-mode-label'>{{ 'Tags'|trans }}</label>
    <div class='tags form-inline mr-2'>
      <div id='tags_div_{{ Entity.id }}' class='d-flex flex-wrap mb-1'>
        <!--  build the tag array -->
        {% if Entity.entityData.tags|length > 0 %}
          {% set tagsIdArr = Entity.entityData.tags_id|split(',') %}
          {% set tagsValueArr = Entity.entityData.tags|split('|') %}
          {% for tag in tagsValueArr -%}
            <a class='tag margin-1px hover-danger {{ loop.last ? 'mr-2' }}' data-action='unreference-tag' data-tagid='{{ tagsIdArr[loop.index0] }}'>{{ tag|raw }}</a>
          {%- endfor -%}
        {% endif %}
      </div>
      <input type='text' id='createTagInput' data-teamid='{{ App.Users.userData.team }}' data-autocomplete='tags' class='createTagInput form-control' placeholder='{{ 'Add a tag'|trans }}' />
    </div>
  </div>

  <hr>

  <!-- PERMISSIONS -->
  <div class='d-flex mb-2 align-items-center'>
    <!-- CAN READ -->
    {% set rw = 'canread' %}
    {% set can = Entity.entityData.canread|canToHuman %}
    {% include('view-permissions.html') %}
  </div>
  <div class='d-flex mb-2 align-items-center'>
    <!-- CAN WRITE -->
    {% set rw = 'canwrite' %}
    {% set can = Entity.entityData.canwrite|canToHuman %}
    {% include('view-permissions.html') %}
  </div>

  <hr>


  <!-- BODY -->
  <div class='mt-4' {{ not displayMainText ? 'hidden' }}>{# << this div is important around the textarea to fix an issue on mobile editor. See #3107 #}
    {% if editor == 'md' %}
      <textarea aria-label='{{ 'Main content'|trans }}' id='body_area' class='markdown-textarea' data-language='{{ App.getJsLang }}' name='body'>{{ Entity.entityData.body }}</textarea>
    {% else %}
    {# do not display body if set in metadata, done via css to avoid delayed disappearance after JS is executed #}
      <textarea aria-label='{{ 'Main content'|trans }}' id='body_area' class='mceditable invisible' name='body' rows='15' cols='80'>{{ Entity.entityData.body }}</textarea>
    {% endif %}
  </div>


  <div class='mt-4 text-center'>
    <button {{ not displayMainText ? 'hidden' }} data-action='update-entity-body' class='btn btn-primary'>{{ 'Save'|trans }}</button>
    <button data-action='update-entity-body' data-redirect='view' class='btn btn-secondary'>{{ 'Save and go back'|trans }}</button>
  </div>


</section>

{# EXTRA FIELDS #}
<h3 data-action='toggle-next' class='d-inline togglable-section-title'><i class='fas fa-caret-down fa-fw mr-2'></i>{{ 'Extra fields'|trans }}</h3>
{# this div is filled in JS by Metadata.class.ts edit() #}
<div id='metadataDiv' data-save-hidden='metadataDiv' class='col-md-6 mt-4'></div>
<button type='button' data-action='toggle-modal' data-target='fieldBuilderModal' class='btn btn-primary mt-3'>{{ 'Add field'|trans }}</button>
<hr>

{# STEPS #}
{% include 'steps-links-edit.html' %}

{# UPLOAD FORM: not togglable or dropzone doesn't register #}
<h3 class='d-inline togglable-section-title'><i class='fas fa-caret-down fa-fw mr-2'></i>{{ 'Attach a file'|trans }}</h3>
<form action='api/v2/{{ Entity.type }}/{{ Entity.id }}/uploads' class='dropzone hl-hover-gray mt-2 rounded' id='elabftw-dropzone'></form>

{% include 'uploads.html' %}

{% include 'json-editor.html' %}

<hr>

<!-- DOODLE -->
<h3 data-action='toggle-next' class='d-inline togglable-section-title'><i class='fas fa-caret-right fa-fw mr-2'></i>{{ 'Draw something'|trans }}</h3>
<div id='doodleDiv' hidden class='mt-2' data-save-hidden='doodleDiv'>
  <div class='row flex-nowrap'>
    <div class='col-md-6 mr-2'>
      <canvas class='bg-white w-100 rounded' id='doodleCanvas'></canvas>
    </div>

    <div class='col-md-6'>
      <hr>
      <div>
        <label for='doodleStrokeStyle'>{{ 'Color'|trans }}</label>
        <input type='color' name='strokeStyle' value='#29aeb9' id='doodleStrokeStyle' />
      </div>

      <hr>

      <div id='doodleStrokeWidthContainer'>
        <label for='doodleStrokeWidth'>{{ 'Stroke width'|trans }}</label>
        <input type='range' min='1' max='20' name='strokeWidth' value='5' id='doodleStrokeWidth' />
      </div>

      <hr>

      <div>
        <input type='checkbox' id='doodleEraser' /> <label for='doodleEraser'>{{ 'Eraser'|trans }}</label>
      </div>

      <div>
        <button id='clearCanvas' class='btn btn-danger'>{{ 'Clear'|trans }}</button>
        <button id='saveCanvas' class='btn btn-primary' data-type='{{ Entity.type }}' data-id='{{ Entity.id }}'>{{ 'Save'|trans }}</button>
      </div>
      <p>{{ 'Use %sCtrl%s + click to add text'|trans|format('<kbd>', '</kbd>')|raw }}</p>
    </div>
  </div>
</div>

<hr>

<!-- CHEM EDITOR -->
<h3 data-action='toggle-next' class='d-inline togglable-section-title'><i class='fas fa-caret-right fa-fw mr-2'></i>{{ 'Molecule editor'|trans }}</h3>
<div id='chemDiv' hidden data-save-hidden='chemDiv' class='mt-2 mb-2 chemdoodle'>
  <div>
    <canvas id='sketcher'></canvas>
  </div>
  <div class='mt-3'>
    <button class='btn btn-primary mr-3' data-filetype='chemjson' data-action='save-chem-as-file'>{{ 'Save as JSON'|trans }}</button>
    <button class='btn btn-primary' data-filetype='png' data-action='save-chem-as-file'>{{ 'Save as image'|trans }}</button>
  </div>
</div>

<div id='info'
    data-page='edit'
    data-maxsize='{{ maxUploadSize }}'
    data-type='{{ Entity.type }}'
    data-id='{{ Entity.id }}'
    data-scsubmit='{{ Entity.Users.userData.sc_submit }}'>
</div>
<div id='shortcuts'
    data-create='{{ Entity.Users.userData.sc_create }}'>
</div>

{% endblock body %}
