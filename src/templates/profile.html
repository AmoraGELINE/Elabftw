{% extends 'base.html' %}

{% block body %}
{% include 'export-modal.html' %}
<ul class='tabbed-menu'>
  <li><button type='button' class='btn' data-action='switch-tab' data-tabtarget='1'>{{ 'Information'|trans }}</button></li>
  <li><button type='button' class='btn' data-action='switch-tab' data-tabtarget='2'>{{ 'Import'|trans }}</button></li>
  <li><button type='button' class='btn' data-action='switch-tab' data-tabtarget='3'>{{ 'Export'|trans }}</button></li>
</ul>

{# loading spinner #}
<div class='d-flex justify-content-center' id='loading-spinner'>
  <div class='lds-dual-ring'></div>
</div>


{# TAB 1 INFORMATION #}
<div data-tabcontent='1' hidden>
  <h3 class='p-2 pl-3 section-title'>{{ 'Profile'|trans }}</h3>
  <div class='pl-3 mt-2'>
    <h4>{{ App.Users.userData.fullname }}</h4>
    <p class='smallgray'>{{ App.Users.userData.email }}</p>

    <div class='d-flex mb-4'>

      {# TEAMS #}
      <div class='col-md-6 mr-2 box bg-white'>
        <div class='mb-4'>
          <h5 class='d-inline mr-2'>{{ 'Teams'|trans }}</h5> <span class='counter'>{{ teamsArr|length }}</span>
        </div>
        {% for team in teamsArr %}
          <span class=''>{{ team.name }}</span>
          <hr>
        {% endfor %}
      </div>

      {# GROUPS #}
      <div class='col-md-6 box bg-white'>
        <div class='mb-4'>
          <h5 class='d-inline mr-2'>{{ 'Groups'|trans }}</h5> <span class='counter'>{{ teamGroupsArr|length }}</span>
        </div>
        {% for teamGroup in teamGroupsArr %}
          <details>
            <summary class='mb-3'><span class='badge badge-secondary'>{{ teamGroup.team }}</span> {{ teamGroup.name }}</summary>
            <ul>
          {% for user in teamGroup.users %}
            <li class='list-unstyled text-muted'>{{ user.fullname }}</li>
          {% endfor %}
            </ul>
          </details>
          <hr>
        {% endfor %}
      </div>
    </div>

    {# STATUS STAT #}
    <div class='mb-4 box'>
      {% if count == 0 %}
        {{ 'No statistics available yet.'|trans }}
      {% else %}
        <div class='mb-4'>
          <h5 class='d-inline mr-2'>{% trans %}
              Experiment
              {% plural 2 %}
              Experiments
              {% endtrans %}</h5> <span class='counter'>{{ count }}</span>
        </div>

        {# TODO show register date back #}
        <div class='d-flex'>
          <div class='col-md-6 mr-2'>
            <div class='pie-chart-container'>
              <div class='pie-chart' style='--pie-data: {{ pieDataCss }}'></div>
            </div>
          </div>
          <div class='col-md-6 flex-column'>
            {% for status in pieData %}
              <div class='d-flex font-weight-bold'>
                <span class='pie-percent mr-3' style='--bg: {{ status.color }}'>{{ status.percent }}%</span>
                <span class='align-self-center'>{{ status.name }}</span>
                <span class='align-self-center ml-auto'>{{ status.count }}</span>
              </div>
              {% if not loop.last %}
                <hr>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{# TAB 2 IMPORT #}
<div data-tabcontent='2' hidden>
  <h3 class='p-2 pl-3 section-title'>{{ 'Import'|trans }}</h3>
  <div class='pl-3 mt-2'>
    <p class='smallgrey'>
      {{ 'You can import data from a .eln archive or a .csv file. %sSee documentation %s%s.'|trans|format("<a href='https://doc.elabftw.net/user-guide.html#importing-data' target='_blank' class='external-link' rel='noopener'>", "", '</a>')|raw }}
    </p>
    <h4>{{ 'Import a CSV file'|trans }}</h4>
    <form class='form-group' enctype='multipart/form-data' action='api/v2/import' method='post' aria-label='{{ 'Import file'|trans }}'>
      {{ App.Session.get('csrf')|csrf }}
      <label for='importSelectCategory'>{{ 'Select a category'|trans }}</label>
      <select class='form-control' id='importSelectCategory' autocomplete='off' name='category'>
        <option disabled>{{ 'Resources categories'|trans }}</option>
        {% for cat in itemsCategoryArr %}
          <option value='{{ cat.id }}'>{{ cat.title }}</option>
        {% endfor %}
        <option disabled>{{ 'Experiments categories'|trans }}</option>
        {% for cat in experimentsCategoryArr %}
          <option value='{{ cat.id }}'>{{ cat.title }}</option>
        {% endfor %}
      </select>

      {# if we are admin we can select the owner #}
      {% if App.Users.isAdmin %}
        <label for='importSelectOwner'>{{ 'Select owner of imported elements'|trans }}</label>
        <select class='form-control' id='importSelectOwner' autocomplete='off' name='owner'>
          {% for user in usersArr %}
            <option value='{{ user.userid }}'>{{ user.fullname }}</option>
          {% endfor %}
        </select>
      {% endif %}

      <label for='import_modal_canread'>{{ '2. Select a visibility:'|trans }}</label>
      <select class='form-control' id='import_modal_canread' autocomplete='off' name='canread'>
        {% for key, value in visibilityArr %}
          <option value='{{ key }}'
          {{ 30 == key ? ' selected' }}
          >{{ value|trans }}</option>
          {% endfor %}
      </select>

      <label for='import_modal_canwrite'>{{ '2b. Select write access:'|trans }}</label>
      <select class='form-control' id='import_modal_canwrite' autocomplete='off' name='canwrite'>
        {% for key, value in visibilityArr %}
          <option value='{{ key }}'
          {{ 20 == key ? ' selected' }}
          >{{ value|trans }}</option>
        {% endfor %}
      </select>

      <label class='d-block' for='import_modal_file_input'>{{ '3. Select a file to import:'|trans }}</label>
      <input id='import_modal_file_input' required name='file' type='file' accept='.eln,.csv' />
      <input name='type' type='hidden' value='archive' />
      <p class='smallgray'>{{ 'Allowed extensions: .eln, .csv'|trans }}<br>
      {{ 'Maximum size: %s'|format(maxUploadSizeRaw)|trans }}</p>

      <div class='mt-4 text-center'>
        <div id='errorHolder' class='alert-danger m-2'></div>
        <button type='submit' data-action='check-max-size' data-maxsize='{{ maxUploadSize }}' data-input='import_modal_file_input' class='btn btn-primary'>{{ 'Import'|trans }}</button>
      </div>

    </form>

    <h4>{{ 'Import an ELN archive'|trans }}</h4>
  </div>
</div>

{# TAB 3 EXPORT #}
<div data-tabcontent='3' hidden>
  <h3 class='p-2 pl-3 section-title'>{{ 'Export'|trans }}</h3>
  <div class='pl-3 mt-2'>
    <p class='smallgrey'>{{ 'This page allows you to export your data in different formats.'|trans }}</p>
    <div class='mb-4 d-flex flex-row'>
      <button type='button' class='btn btn-primary' data-action='toggle-modal' data-target='exportModal'>{{ 'Create new export'|trans }}</button>
    </div>

    <h4 id='exportedFiles'>{{ 'Exported files'|trans }}</h4>
    {% if not exportedFiles %}
      {{ 'Use the button above to create an export.'|trans }}
    {% endif %}
    {# Refresh button #}
    <div class='text-center'>
      <button type='button' aria-label='{{ 'Refresh'|trans }}' class='btn btn-secondary btn-sm mb-2' data-reload-on-click='exportedFilesTable'><i class='fas fa-rotate color-white mr-1'></i>{{ 'Refresh'|trans }}</button>
    </div>
    <ul class='list-group' id='exportedFilesTable'>
      {% for file in exportedFiles %}
        <li class='list-group-item py-3 px-2 m-1'>
          <span class='d-flex flew-wrap'>
            <span>
              <button class='btn p-2 hl-hover-gray lh-normal border-0 my-n2 mr-2' data-toggle-plus-icon='1' data-toggle-target='showMoreDiv_{{ file.id }}' data-action='toggle-next' data-keep-icon='1' title='{{ 'Show more'|trans }}' aria-label='{{ 'Show more'|trans }}'><i class='fas fa-square-plus fa-fw link-like'></i></button>
              <span class='state-indicator' data-state='{{ file.state }}' data-id='{{ file.id }}'>‚óè</span>
              {% if file.real_name %}
                <a title='{{ 'Download'|trans }}' class='rounded hl-hover-gray p-1' target='_blank' href='/api/v2/exports/{{ file.id }}?format=binary'>
                  {{ file.real_name }} <span class='smallgray'>{{ file.filesize|default(0)|formatBytes }}</span>
                </a>
                <span class='smallgray relative-moment ml-1' title='{{ file.created_at }}'></span>
              {% else %}
                {{ 'File is not ready'|trans }}
              {% endif %}
              <span class='ml-2'>
              <span class='p-1 rounded smallgray border'>{{ file.format|upper }}</span>
              {% if file.changelog %}<span class='p-1 rounded smallgray border'>{{ 'Changelog'|trans|upper }}</span>{% endif %}
              {% if file.pdfa %}<span class='p-1 rounded smallgray border'>{{ 'PDF/A'|trans }}</span>{% endif %}
              {% if file.json %}<span class='p-1 rounded smallgray border'>{{ 'JSON'|trans|upper }}</span>{% endif %}
              </span>
              {% if file.filepath %}
                <a href='/api/v2/export/{{ file.id }}?format=binary'>
                <button type='button' class='btn hl-hover-gray lh-normal border-0 p-2 m-0 my-n2' title='{{ 'Download'|trans }}' aria-label='{{ 'Download'|trans }}'><i class='fas fa-download fa-fw'></i></button>
                </a>
              {% endif %}
            </span>
          <button type='button' class='btn p-2 hl-hover-gray lh-normal border-0 my-n2 ml-auto' data-action='destroy-export' title='{{ 'Delete'|trans }}' aria-label='{{ 'Delete'|trans }}' data-id='{{ file.id }}'><i class='fas fa-trash-alt fa-fw'></i></button>
          </span>
          {# SHOW MORE #}
          <div id='showMoreDiv_{{ file.id }}' class='mt-2' hidden>
            <hr>
            <span class='p-2 my-n2 mr-2'><i class='fas fa-fingerprint fa-fw'></i></span>
            {%- if file.hash -%}
              <span class='p-1 rounded smallgray border m-1'>{{ file.hash_algo|upper }}</span>{{- file.hash -}}
            {%- else -%}
              {{- 'File is not ready'|trans -}}
            {%- endif -%}
          </div>
        </li>
      {% endfor %}
    </ul>
</div>
{% endblock body %}
